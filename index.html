<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Skript Parser</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }

    textarea {
      width: 100%;
      height: 200px;
      font-family: monospace;
      font-size: 14px;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      font-weight: bold;
    }

    .error-box {
      background: #1c1c1c;
      border-left: 5px solid #e63946;
      color: white;
      margin-top: 15px;
      padding: 10px 15px;
      border-radius: 6px;
    }

    .error-box .title {
      font-weight: bold;
      color: #ffffff;
    }

    .error-box .message {
      color: #cccccc;
      margin: 5px 0;
    }

    .error-box .code {
      background: #2c2c2c;
      padding: 5px 10px;
      font-family: monospace;
      font-size: 13px;
      color: #d3d3d3;
      margin-top: 5px;
      display: inline-block;
    }

    .success {
      color: green;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <h2>Meggy-mode's Skript Parser</h2>
  <textarea id="skriptInput" placeholder="Enter your Skript code here..."></textarea>
  <br>
  <button onclick="validateSkript()">Validate</button>
  <div id="result"></div>

  <script>
    class SkriptValidator {
      constructor() {
        this.errors = [];
        this.lines = [];
        this.inBlock = false;
        this.expectedIndent = 0;
      }

      validate(script) {
        this.errors = [];
        this.lines = script.split("\n");
        this.inBlock = false;
        this.expectedIndent = 0;

        for (let i = 0; i < this.lines.length; i++) {
          const raw = this.lines[i];
          const trimmed = raw.trim();

          // Skip comments or empty lines
          if (trimmed === "" || trimmed.startsWith("#")) continue;

          const indent = this.countIndent(raw);

          // Check for valid trigger lines
          if (this.isTrigger(trimmed)) {
            this.inBlock = true;
            this.expectedIndent = indent + 2;

            // Check if a trigger line ends with a colon
            if (!this.isValidColonEnding(trimmed)) {
              this.errors.push({line: i + 1, msg: "trigger lines must end with a colon", code: raw});
            }
            continue;
          }

          if (this.inBlock) {
            if (indent < this.expectedIndent) {
              this.errors.push({line: i + 1, msg: "code inside a trigger must be indented", code: raw});
              continue;
            }
          } else {
            this.errors.push({line: i + 1, msg: "invalid line - all code must be inside a trigger", code: raw});
            continue;
          }

          if (
            !this.isValidSet(trimmed) &&
            !this.isValidSend(trimmed) &&
            !this.isValidIf(trimmed) &&
            !this.isValidLoop(trimmed)
          ) {
            this.errors.push({line: i + 1, msg: "invalid command or syntax", code: raw});
          }

          // Additional check for control structures like 'if', 'loop', etc.
          if (this.isValidIf(trimmed) || this.isValidLoop(trimmed)) {
            if (!this.isValidColonEnding(trimmed)) {
              this.errors.push({line: i + 1, msg: "control structures must end with a colon", code: raw});
            }
          }
        }

        return this.errors;
      }

      countIndent(line) {
        return line.match(/^\s*/)[0].length;
      }

      isTrigger(line) {
        return /^on\s+([A-Za-z]+(\s+[A-Za-z]+)*(\s*\/\s*[A-Za-z]+)*(\s+[A-Za-z]+)*(\s*\/\s*[A-Za-z]+)*)?(:)$/i.test(line);
      }

      isValidSet(line) {
        const varPattern = '\\{[a-zA-Z0-9_]+(?:::[^{}%]+(?:%[^%]+%[^{}%]*%)*)?\\}'; // Match variables with optional list syntax and parsed values

        // Return true if any of the patterns match
        return (
          new RegExp(`^set\\s+${varPattern}\\s+to\\s+.+$`).test(line) ||  // normal or list variable with assignment
          new RegExp(`^add\\s+\\d+\\s+to\\s+${varPattern}$`).test(line) ||  // add to list variable or regular variable
          new RegExp(`^remove\\s+\\d+\\s+from\\s+${varPattern}$`).test(line) ||  // remove from list variable or regular variable
          new RegExp(`^set\\s+\\{[a-zA-Z0-9_]+::%[^%]+%\\}\\s+to\\s+.+$`).test(line) ||  // Check for list variable with a player-based or parsed value, e.g., {_item::%player%}
          new RegExp(`^add\\s+\\d+\\s+to\\s+\\{[a-zA-Z0-9_]+::%[^%]+%\\}$`).test(line) ||  // Add to list variable with a player-based or parsed value
          new RegExp(`^remove\\s+\\d+\\s+from\\s+\\{[a-zA-Z0-9_]+::%[^%]+%\\}$`).test(line) ||  // Remove from list variable with parsed value
          new RegExp(`^add\\s+\\d+\\s+to\\s+\\{[a-zA-Z0-9_]+::[a-zA-Z0-9_]+\\}$`).test(line) ||  // Add to list variable with static key (no parsed value)
          new RegExp(`^remove\\s+\\d+\\s+from\\s+\\{[a-zA-Z0-9_]+::[a-zA-Z0-9_]+\\}$`).test(line) // Remove from list variable with static key
        );
      }

      isValidSend(line) {
        return /^send\s+".+"$/.test(line);
      }

      isValidIf(line) {
        return /^if\s+[\w\s"'.%:{}<>=!&|\-+()*]+:$/i.test(line);
      }

      isValidLoop(line) {
        return /^loop\s+.+:$/.test(line);
      }

      // New method to check if a line should end with a colon
      isValidColonEnding(line) {
        return line.trim().endsWith(':');
      }
    }

    function validateSkript() {
      const input = document.getElementById("skriptInput").value;
      const validator = new SkriptValidator();
      const errors = validator.validate(input);

      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = "";

      if (errors.length === 0) {
        resultDiv.innerHTML = "<div class='success'>âœ… No syntax errors found!</div>";
      } else {
        errors.forEach(err => {
          const box = document.createElement("div");
          box.className = "error-box";
          box.innerHTML = `
            <div class="title">Error on Line ${err.line}</div>
            <div class="message">${err.msg}</div>
            <div class="code">${err.code}</div>
          `;
          resultDiv.appendChild(box);
        });
      }
    }
  </script>

</body>

</html>
